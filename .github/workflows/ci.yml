name: Go CI

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run tests
        run: go test ./...

  publish-docs:
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Trigger pkg.go.dev indexing
        env:
          MODULE_PATH: github.com/andrey-viktorov/jsonfilter-go
          VERSION: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          proxy_url="https://proxy.golang.org/${MODULE_PATH}/@v/${VERSION}.info"
          pkg_url="https://pkg.go.dev/${MODULE_PATH}@${VERSION}"

          echo "Triggering Go proxy fetch: ${proxy_url}"
          for attempt in {1..5}; do
            if curl -fsS "${proxy_url}" >/dev/null; then
              echo "Go proxy acknowledged version on attempt ${attempt}."
              break
            fi
            echo "Go proxy not ready (attempt ${attempt}); waiting 15s..."
            sleep 15
          done

          echo "Hinting pkg.go.dev: ${pkg_url}"
          pkg_success=0
          for attempt in {1..8}; do
            if curl -fsS "${pkg_url}" >/dev/null; then
              echo "pkg.go.dev responded on attempt ${attempt}."
              pkg_success=1
              break
            fi
            echo "pkg.go.dev not ready yet (attempt ${attempt}); waiting 30s..."
            sleep 30
          done

          if [ ${pkg_success} -eq 0 ]; then
            echo "pkg.go.dev still returning 404 after retries; continuing without failing."
          fi
